<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Transfer Money - Nexa Bank</title>

    <!-- SUCCESS SOUND -->
    <audio id="successSound">
        <source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg">
    </audio>

    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f7fc;
            color: #0d1b3d;
        }

        .navbar {
            background-color: #0d1b3d;
            color: #f7d65b;
            padding: 20px 40px;
            font-size: 24px;
            font-weight: bold;
        }

        .container {
            width: 50%;
            min-width: 320px;
            margin: 40px auto;
            background: #ffffff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        h2 { color:#0d1b3d; font-size:28px; margin:0 0 6px 0; }
        .subtitle { color:#6d7b99; margin-bottom:22px; font-size:15px; }

        input, textarea {
            width: 95%;
            padding:14px;
            border:2px solid #cfd5e3;
            border-radius:8px;
            margin-top:8px;
            font-size:16px;
        }

        input:focus, textarea:focus { border-color:#0d1b3d; }

        .inline-row { display:flex; gap:12px; align-items:center; width:95%; }

        .btn {
            padding:14px 20px;
            border-radius:10px;
            border:none;
            font-weight:700;
            cursor:pointer;
            background:#f7d65b;
            color:#0d1b3d;
            font-size:16px;
        }

        .btn.alt { background:#0d1b3d; color:#fff; }

        .processing-box {
            display:none;
            margin-top:20px;
            padding:18px;
            border-left:5px solid #e6b800;
            background:#fff7d1;
            border-radius:10px;
            color:#826300;
        }

        .success-box {
            display:block;
            margin-top:20px;
            padding:18px;
            border-left:5px solid #0a7b0a;
            background:#e8f7e8;
            border-radius:10px;
            color:#0a7b0a;
            font-weight:700;
        }

        .error-box {
            margin-top:20px;
            padding:18px;
            border-left:5px solid #d9534f;
            background:#ffe5e5;
            border-radius:10px;
            color:#b30000;
            font-weight:700;
        }

        /* Receipt box */
        #receipt-box {
            background:#fff !important;
            margin-top:20px;
            padding:20px;
            border-radius:12px;
            border-left:5px solid #0d1b3d;
            color:#000 !important;
        }

        #receipt-box * { color:#000 !important; font-weight:600 !important; }

      .download-btn {
    margin-top: 15px;
    width: 100%;
    padding: 14px;
    background-color: #0d1b3d !important;
    color: #ffffff !important; /* FIX: Make text white */
    border: none;
    border-radius: 8px;
    font-weight: 900 !important;
    font-size: 16px;
    letter-spacing: 1px;
    cursor: pointer;
    text-transform: uppercase;
    text-align: center;
}
.download-btn,
.download-btn *,
#receipt-box .download-btn,
#receipt-box .download-btn * {
    color: #ffffff !important;
    fill: #ffffff !important;   /* in case it was an SVG */
    font-weight: 900 !important;
}
        /* STATUS TEXT */
        .success-text { color:green; font-weight:700; }
        .error-text { color:red; font-weight:700; }

        /* POPUP MODAL */
        #confirmModal {
            display:none;
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background:rgba(0,0,0,0.45);
            justify-content:center;
            align-items:center;
        }
        .modal-box {
            background:white;
            padding:25px;
            border-radius:10px;
            width:320px;
            text-align:center;
            box-shadow:0 8px 20px rgba(0,0,0,0.25);
        }
        .button-row {
    display: flex;
    gap: 20px;
    margin-top: 25px;
    width: 95%;
}

.equal-btn {
    width: 50%;
    padding: 14px;
    background-color: #f7d65b;
    color: #0d1b3d;
    font-size: 17px;
    font-weight: bold;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    text-align: center;
}

.equal-btn-alt {
    width: 50%;
    padding: 14px;
    background-color: #0d1b3d;
    color: #ffffff;
    font-size: 17px;
    font-weight: bold;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
    display: flex;
    justify-content: center;
    align-items: center;
}
.button-row {
    display: flex;
    gap: 20px;
    margin-top: 25px;
    width: 95%;
}

.equal-btn {
    width: 50%;
    padding: 14px;
    background-color: #f7d65b;
    color: #0d1b3d;
    font-size: 17px;
    font-weight: bold;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    text-align: center;
}
.pin-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.pin-container {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.pin-input {
    width: 30px;
    height: 30px;
    font-size: 22px;
    text-align: center;
    border: 2px solid #cfd5e3;
    border-radius: 8px;
}

.pin-input:focus {
    border-color: #0d1b3d;
}

.show-pin-row {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-top: 6px;
}

.equal-btn-alt {
    width: 50%;
    padding: 14px;
    background-color: #0d1b3d;
    color: #ffffff;
    font-size: 17px;
    font-weight: bold;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
    display: flex;
    justify-content: center;
    align-items: center;
}

    </style>

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>

        function playSuccess() {
            const audio = document.getElementById("successSound");
            audio.volume = 0.4;
            audio.play();
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const receipt = document.getElementById("receipt-box");

            const canvas = await html2canvas(receipt, { scale: 3 });
            const imgData = canvas.toDataURL("image/png");
            const pdf = new jsPDF("p","pt","a4");

            const imgWidth = 550;
            const imgHeight = canvas.height * imgWidth / canvas.width;

            pdf.addImage(imgData, "PNG", 20, 20, imgWidth, imgHeight);
            pdf.save("NexaBank_Transfer_Receipt.pdf");
        }

        /* Check recipient account */
       async function checkRecipient() {
        const sender = document.querySelector("input[name='fromAccount']").value.trim();
        const acc = document.getElementById('toAccount').value.trim();
        const status = document.getElementById('recipientStatus');

        if (acc.length < 5) {
            status.textContent = "";
            return;
        }

        // üö´ Block self-transfer instantly
        if (acc === sender) {
            status.className = "note error-text";
            status.textContent = "‚úò You cannot transfer money to your own account.";
            document.getElementById("recipientVerified").value = "false";
            return;
        }

        status.textContent = "Checking...";
        status.className = "note";

        try {
            const res = await fetch('/api/check-account?acc=' + encodeURIComponent(acc));
            const data = await res.json();

            if (data.found) {
                status.className = "note success-text";
                status.textContent = "‚úî Account found: " + data.name;
                document.getElementById("recipientName").value = data.name;
                document.getElementById("recipientVerified").value = "true";
            } else {
                status.className = "note error-text";
                status.textContent = "‚úò Account not found";
                document.getElementById("recipientVerified").value = "false";
            }

        } catch (e) {
            status.className = "note error-text";
            status.textContent = "Network error.";
        }
    }
        function openConfirm() {
            const verified = document.getElementById("recipientVerified").value;
            const name = document.getElementById("recipientName").value;
            const amount = document.querySelector("input[name='amount']").value;

            if (verified !== "true") {
                alert("Please verify recipient account number.");
                return;
            }

            document.getElementById("modalText").innerText =
                    `Do you want to send ‚Çπ${amount} to ${name}?`;

            document.getElementById("confirmModal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("confirmModal").style.display = "none";
        }

        function submitTransfer() {
            closeModal();
            document.getElementById("processing").style.display = "block";

            setTimeout(() => {
                document.getElementById("transferForm").submit();
            }, 500);
        }

    </script>

</head>

<body>

<div class="navbar">NEXA BANK</div>

<div class="container">

    <h2>Transfer Money</h2>
    <div class="subtitle">Secure ‚Äî Instant ‚Äî Trusted</div>

    <!-- Processing -->
    <div id="processing" class="processing-box">‚è≥ Processing transfer‚Ä¶ Please wait.</div>

    <!-- Success -->
    <div th:if="${success}" class="success-box">
        ‚úî <span th:text="${success}"></span>
        <script>playSuccess();</script>
    </div>

    <!-- Error -->
    <div th:if="${error}" class="error-box">
        ‚ùå <span th:text="${error}"></span>
    </div>

    <!-- RECEIPT -->
    <div th:if="${transactionId}" id="receipt-box">
        <h3>üßæ Nexa Bank - Transfer Receipt</h3>

        <p><strong>Transaction ID:</strong> <span th:text="${transactionId}"></span></p>
        <p><strong>Date:</strong> <span th:text="${date}"></span></p>
        <p><strong>Time:</strong> <span th:text="${time}"></span></p>

        <p><strong>From Account:</strong> <span th:text="${fromAccount}"></span></p>
        <p><strong>To Account:</strong> <span th:text="${toAccount}"></span></p>
        <p><strong>Recipient Name:</strong> <span th:text="${recipientName}"></span></p>

        <p><strong>Amount:</strong> ‚Çπ<span th:text="${amount}"></span></p>
        <p><strong>Updated Balance:</strong> ‚Çπ<span th:text="${updatedBalance}"></span></p>

        <button onclick="downloadPDF()" class="download-btn">DOWNLOAD RECEIPT (PDF)</button>
    </div>

    <!-- Transfer Form -->
    <form id="transferForm" th:action="@{'/transfer'(accountNumber=${accountNumber})}" method="post">

        <label>From Account</label>
        <input type="text" name="fromAccount" th:value="${accountNumber}" readonly />

        <label>Recipient Account Number</label>
        <div class="inline-row">
            <input id="toAccount" name="toAccount" type="text" oninput="checkRecipient()" required />
            <button type="button" class="btn" onclick="checkRecipient()">Check</button>
        </div>
        <div id="recipientStatus" class="note"></div>

        <input type="hidden" id="recipientName" name="recipientName" value="" />
        <input type="hidden" id="recipientVerified" name="recipientVerified" value="false" />

        <label>Amount (‚Çπ)</label>
        <input type="number" name="amount" min="1" required />

        <label>Remarks (optional)</label>
        <textarea name="remarks" rows="2"></textarea>
        <!-- PIN INPUT -->
        <label><strong>Enter PIN</strong></label>

        <div class="pin-wrapper">
            <div class="pin-container">
                <input type="password" maxlength="1" class="pin-input" required>
                <input type="password" maxlength="1" class="pin-input" required>
                <input type="password" maxlength="1" class="pin-input" required>
                <input type="password" maxlength="1" class="pin-input" required>
            </div>

            <div class="show-pin-row">
                <input type="checkbox" id="showPinCheckbox" onclick="togglePinVisibility()">
                <label for="showPinCheckbox">Show PIN</label>
            </div>
        </div>

        <!-- hidden full pin -->
        <input type="hidden" id="fullPin" name="pin">

        <div class="button-row">
            <button class="equal-btn" type="button" onclick="openConfirm()">Confirm Transfer</button>

            <a th:href="@{'/dashboard'(accountNumber=${accountNumber})}" class="equal-btn-alt">
                Back to Dashboard
            </a>
        </div>

    </form>

</div>

<!-- CONFIRMATION POPUP -->
<div id="confirmModal">
    <div class="modal-box">
        <h3 id="modalText"></h3>

        <button onclick="submitTransfer()" class="btn" style="background:#0d1b3d; color:white; margin-right:10px;">YES</button>
        <button onclick="closeModal()" class="btn" style="background:#ccc;">NO</button>
    </div>
</div>
<script>
    const pinInputs = document.querySelectorAll(".pin-input");

    // move between boxes
    pinInputs.forEach((input, index, arr) => {
        input.addEventListener("input", () => {
            if (input.value.length === 1 && arr[index + 1]) {
                arr[index + 1].focus();
            }
            updateFullPin();
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace" && index > 0 && !input.value) {
                arr[index - 1].focus();
            }
        });
    });

    function updateFullPin() {
        let fullPin = "";
        pinInputs.forEach(i => fullPin += i.value);
        document.getElementById("fullPin").value = fullPin;
    }

    function togglePinVisibility() {
        const show = document.getElementById("showPinCheckbox").checked;
        pinInputs.forEach(i => {
            i.type = show ? "text" : "password";
        });
    }
</script>

</body>
</html>
